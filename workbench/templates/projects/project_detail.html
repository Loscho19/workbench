{% extends "base.html" %}

{% load history i18n mark_current workbench %}

{% block title %}{{ project }} - {% trans "projects" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
<div class="col-md-12">

  <h1>{{ project|h }} {% history_link project %}</h1>
  <ul class="nav nav-tabs">
    {% mark_current request.path %}
    <li class="nav-item"><a class="nav-link" href="{{ project.urls.overview }}">{% trans 'overview' %}</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ project.urls.services }}">{% trans 'services' %}</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ project.urls.costs }}">{% trans 'costs' %}</a></li>
    {% endmark_current %}
  </ul>

  {% if view.project_view == 'overview' %}

    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8">

        <table class="table table-striped">
          <tr>
            <th class="text-right">{% trans 'description' %}</th>
            <td>{{ project.description|linebreaksbr|default:'&ndash;' }}</td>
          </tr>
          <tr>
            <th class="text-right">
              {% trans 'Overall' %}
            </th>
            <td>
              {% with overview=project.overview %}
              {{ overview.logged }}h / {{ overview.effort }}h
              {% endwith %}
            </td>
          </tr>
          <tr>
            <th class="text-right">{% trans 'customer' %}</th>
            <td>{% link_or_none project.customer %}</td>
          </tr>
          <tr>
            <th class="text-right">{% trans 'contact' %}</th>
            <td>{% link_or_none project.contact project.contact.full_name %}</td>
          </tr>
          <tr>
            <th class="text-right">{% trans 'owned by' %}</th>
            <td>{{ project.owned_by.get_full_name }}</td>
          </tr>
          <tr>
            <th class="text-right">{% trans 'status' %}</th>
            <td><span class="badge badge-{{ object.status_css }}">
              {{ object.pretty_status }}
            </span></td>
          </tr>
          <tr>
            <th class="text-right">{% trans 'offers' %}</th>
            {% with offers=project.offers.all %}
            {% if offers %}
              <td class="nopad">
                <table class="table">
                  <thead>
                    <tr>
                      <th>{% trans 'offer' %}</th>
                      <th>{% trans 'status' %}</th>
                      <th class="text-right">{% trans 'total excl. tax' %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for offer in offers %}
                      <tr>
                        <th><a href="{{ offer.get_absolute_url }}">{{ offer }}</a></th>
                        <td>{{ offer.pretty_status }}</td>
                        <td class="text-right">{{ offer.total_excl_tax|currency }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            {% else %}<td>&ndash;</td>{% endif %}
            {% endwith %}
          </tr>
          <tr>
            <th class="text-right">{% trans 'invoices' %}</th>
            {% with invoices=project.invoices.all %}
            {% if invoices %}
              <td class="nopad">
                <table class="table">
                  <thead>
                    <tr>
                      <th>{% trans 'invoice' %}</th>
                      <th>{% trans 'type' %}</th>
                      <th>{% trans 'status' %}</th>
                      <th class="text-right">{% trans 'total excl. tax' %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for invoice in invoices %}
                      <tr>
                        <th><a href="{{ invoice.get_absolute_url }}">{{ invoice }}</a></th>
                        <td>{{ invoice.get_type_display }}</td>
                        <td>{{ invoice.pretty_status }}</td>
                        <td class="text-right">{{ invoice.total_excl_tax|currency }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            {% else %}<td>&ndash;</td>{% endif %}
            {% endwith %}
          </tr>
        </table>

        <a href="{{ project.urls.createoffer }}" class="btn btn-secondary">
          {% include "svg/plus.svg" %}
          {% trans 'offer' %}</a>
        <a href="{{ project.urls.createinvoice }}" class="btn btn-secondary">
          {% include "svg/plus.svg" %}
          {% trans 'invoice' %}</a>
        <a href="{{ project.urls.createhours }}" class="btn btn-secondary" data-toggle="ajaxmodal" data-createhours>
          {% include "svg/plus.svg" %}
          {% trans 'hours' %}</a>
        <a href="{{ project.urls.update }}" class="btn btn-secondary">
          {% trans 'Update' %}</a>
        <a href="{{ project.urls.delete }}" class="btn btn-outline-danger float-right">
          {% trans 'Delete' %}</a>

        <h2>{% trans 'activities' %}</h2>

        <table class="table">
          {% for activity in project.activities.all %}
            <tr class="{{ activity.css }}">
              <th>
                <a href="{{ activity.urls.detail }}" data-toggle="ajaxmodal">
                  {{ activity }}
                </a>
              </th>
              <td>
                {{ activity.owned_by.get_full_name }}
              </td>
              <td>
                {{ activity.pretty_status }}
              </td>
            </tr>
          {% empty %}
            <tr><th class="nopad">{% trans 'No activities' %}</th></tr>
          {% endfor %}
        </table>
        <a href="{% url 'activities_activity_create' %}?project={{ project.pk }}"
          class="btn btn-secondary"
          data-toggle="ajaxmodal">
          {% include "svg/plus.svg" %} {% trans 'activity' %}
        </a>

      </div>
    </div>

  {% elif view.project_view == 'costs' %}

    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8">

        <table class="table table-hover table-striped">
          <thead>
            <tr>
              <th>{% trans 'created by' %}</th>
              <th>{% trans 'rendered on' %}</th>
              <th>{% trans 'description' %}</th>
              <th class="text-right">{% trans 'cost' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for service, offered, logged, service_costs in costs %}
              <tr>
                <th colspan="3">
                  <strong>
                    {% if service %}
                      <a href="{{ service.get_absolute_url }}">{{ service }}</a>
                      <div style="font-weight:normal">{{ service.description|linebreaksbr }}</div>
                    {% else %}
                      {% trans 'Not offered services' %}
                    {% endif %}
                  </strong>
                </th>
                <th class="text-right">
                  {{ logged|currency }} / {{ offered|currency }}
                </th>
              </tr>

              {% for cost in service.costs.all %}
                <tr>
                  <td colspan="2"></td>
                  <td>{{ cost.title }}</td>
                  <td class="text-right">{{ cost.cost|currency }}</td>
                </tr>
              {% endfor %}

              {% for cost in service_costs %}
                <tr>
                  <td>{{ cost.created_by.get_short_name }}</td>
                  <td>{{ cost.rendered_on|date:'SHORT_DATE_FORMAT' }}</td>
                  <th>
                    <a href="{{ cost.urls.update }}" data-toggle="ajaxmodal">{{ cost.description }}</a>
                  </th>
                  <td class="text-right">{{ cost.cost|currency }}</td>
                </tr>
              {% endfor %}

            {% endfor %}
          </tbody>
        </table>

        <a href="{{ project.urls.createcost }}" class="btn btn-secondary"
          data-toggle="ajaxmodal" data-createhours>
          {% include "svg/plus.svg" %} {% trans 'cost' %}</a>

      </div>
    </div>

  {% endif %}

</div>
</div>
{% endblock %}
