{% extends "base.html" %}

{% load history i18n mark_current workbench %}

{% block title %}{{ project }} - {% trans "projects" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
<div class="col-md-12">

  <h1>{{ project }} {% history_link project %}</h1>
  <ul class="nav nav-tabs">
    {% mark_current request.path %}
    <li><a href="{{ project.urls.overview }}">{% trans 'overview' %}</a></li>
    <li><a href="{{ project.urls.tasks }}">{% trans 'tasks' %}</a></li>
    {% endmark_current %}
  </ul>

  {% if view.project_view == 'overview' %}

    <div class="row"><div class="col-md-6 col-md-offset-3">

      <table class="table table-striped">
        <tr>
          <th class="text-right">{% trans 'description' %}</th>
          <td>{{ project.description|linebreaksbr|default:'&ndash;' }}</td>
        </tr>
        <tr>
          <th class="text-right">
            {% trans 'Overall' %}
          </th>
          <td>
            {% with overview=project.overview %}
            {{ overview.logged }}h / {{ overview.approved }}h
            {% endwith %}
          </td>
        </tr>
        <tr>
          <th class="text-right">{% trans 'customer' %}</th>
          <td>{% link_or_none project.customer %}</td>
        </tr>
        <tr>
          <th class="text-right">{% trans 'contact' %}</th>
          <td>{% link_or_none project.contact project.contact.full_name %}</td>
        </tr>
        <tr>
          <th class="text-right">{% trans 'owned by' %}</th>
          <td>{{ project.owned_by.get_full_name }}</td>
        </tr>
        <tr>
          <th class="text-right">{% trans 'status' %}</th>
          <td><span class="label label-{{ object.status_css }}">
            {{ object.pretty_status }}
          </span></td>
        </tr>
        <tr>
          <th class="text-right">{% trans 'offers' %}</th>
          {% with offers=project.offers.all %}
          {% if offers %}
            <td class="nopad">
              <table class="table">
                <thead>
                  <tr>
                    <th>{% trans 'offer' %}</th>
                    <th>{% trans 'status' %}</th>
                    <th class="text-right">{% trans 'total excl. tax' %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for offer in offers %}
                    <tr>
                      <th><a href="{{ offer.get_absolute_url }}">{{ offer }}</a></th>
                      <td>{{ offer.pretty_status }}</td>
                      <td class="text-right">{{ offer.total_excl_tax|currency }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </td>
          {% else %}<td>&ndash;</td>{% endif %}
          {% endwith %}
        </tr>
      </table>

      <a href="{{ project.urls.createoffer }}" class="btn btn-default">
        <i class="glyphicon glyphicon-plus"></i>
        {% trans 'offer' %}</a>
      <a href="{{ project.urls.update }}" class="btn btn-default">
        {% trans 'Update' %}</a>
      <a href="{{ project.urls.delete }}" class="btn btn-danger btn-inverse pull-right">
        {% trans 'Delete' %}</a>

      <h2>{% trans 'activities' %}</h2>

      <table class="table">
        {% for activity in project.activities.all %}
          <tr class="{{ activity.css }}">
            <th>
              <a href="{{ activity.urls.detail }}" data-toggle="ajaxmodal">
                {{ activity }}
              </a>
            </th>
            <td>
              {{ activity.owned_by.get_full_name }}
            </td>
            <td>
              {{ activity.pretty_status }}
            </td>
          </tr>
        {% empty %}
          <tr><th class="nopad">{% trans 'No activities' %}</th></tr>
        {% endfor %}
      </table>
      <a href="{% url 'activities_activity_create' %}?project={{ project.pk }}"
        class="btn btn-default"
        data-toggle="ajaxmodal">
        <span class="glyphicon glyphicon-plus"></span> {% trans 'activity' %}
      </a>

    </div></div>

  {% else %}

    <table class="table table-hover table-striped">
      <thead>
        <tr>
          <th>{% trans 'type' %}</th>
          <th>{% trans 'priority' %}</th>
          <th>{% trans 'title' %}</th>
          <th>{% trans 'status' %}</th>
          <th>{% trans 'created at' %}</th>
          <th>{% trans 'owned by' %}</th>
          <th class="text-right">{% trans 'hours' %}</th>
        </tr>
      </thead>
      <tbody>
        {% for service_tasks in tasks %}

          <tr>
            <th colspan="6">
              {% if view.project_view == 'tasks' %}
                <strong>
                  {% if service_tasks.service %}
                    <a href="{{ service_tasks.service.get_absolute_url }}">{{ service_tasks.service }}</a>
                  {% else %}
                    {% trans 'Not offered services' %}
                  {% endif %}
                </strong>
              {% endif %}
            </th>
            <th class="text-right">
              {{ service_tasks.logged }}h / {{ service_tasks.approved }}h
            </th>
          </tr>

          {% for task in service_tasks.tasks %}
            <tr>
              <td>
                <i
                  title="{{ task.get_type_display }}"
                  class="{{ task.type_css }}"></i>
              </td>
              <td>
                <span
                  class="{{ task.priority_css }}">{{ task.get_priority_display }}</span>
              </td>
              <th><a href="{{ task.get_absolute_url }}">{{ task|h }}</a></th>
              <td>{{ task.pretty_status }}</td>
              <td>{{ task.created_at|date:'d.m.Y' }}</td>
              <td>
                {{ task.owned_by|default:'&ndash;' }}
              </td>
              <td class="text-right">
                {{ task.logged_hours|default:0 }}h
              </td>
            </tr>
          {% endfor %}

        {% endfor %}
      </tbody>
    </table>

    <a href="{{ project.urls.createtask }}" class="btn btn-default">
      <i class="glyphicon glyphicon-plus"></i> {% trans 'task' %}</a>
    <a href="{{ project.urls.approved_hours }}" class="btn btn-default">
      {% trans 'edit approved hours' %}
    </a>

  {% endif %}

</div>
</div>
{% endblock %}
