{% extends "base.html" %}

{% load bootstrap3 history i18n workbench %}

{% block title %}{{ task }} - {{ task.project }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
<div class="col-md-12">

  <h1>{{ task.project|h }} {% history_link task.project %}</h1>
  <ul class="nav nav-tabs">
    <li><a href="{{ task.project.urls.overview }}">{% trans 'overview' %}</a></li>
    <li class="active"><a href="{{ task.project.urls.tasks }}">{% trans 'tasks' %}</a></li>
    <li><a href="{{ task.project.urls.costs }}">{% trans 'costs' %}</a></li>
  </ul>
</div>
</div>


<div class="row">
  <div class="col-md-8 col-md-offset-2">

    <h1>{{ task|h }}</h1>

    <table class="table table-striped">
      <tr>
        <th class="text-right">{% trans 'description' %}</th>
        <td>{{ object.description_html }}</td>
      </tr>
      <tr>
        <th class="text-right">{% trans 'created' %}</th>
        <td>{{ object.created_at|date:'SHORT_DATETIME_FORMAT' }} {% trans 'by' %} {{ object.created_by }}</td>
      </tr>
      {% for name, value in object|field_value_pairs:'type,priority,owned_by' %}
      <tr>
        <th class="text-right">{{ name }}</th>
        <td>{% link_or_none value %}</td>
      </tr>
      {% endfor %}
      <tr>
        <th class="text-right">{% trans 'service' %}</th>
        <td>
          {% link_or_none object.service %}
          {% with overview=object.overview %}{% if overview %}
            <br>
            {% blocktrans with logged_tasks=overview.logged_tasks logged_this=overview.logged_this approved=overview.approved trimmed %}
              {{ logged_tasks }}h / {{ approved }}h on service. This task accounts for {{ logged_this }}h.
            {% endblocktrans %}
          {% endif %}{% endwith %}
        </td>
      </tr>
      <tr>
        <th class="text-right">{% trans 'status' %}</th>
        <td>{{ object.pretty_status }}</td>
      </tr>
    </table>

    <a href="{{ task.project.urls.createhours }}?task={{ task.id }}"
        data-toggle="ajaxmodal"
        class="btn btn-default">
      <i class="glyphicon glyphicon-plus"></i> {% trans 'hours' %}
    </a>
    <a href="{{ task.urls.update }}" class="btn btn-default">
      {% trans 'Update' %}
    </a>
    <a href="{{ task.urls.delete }}" class="btn btn-danger btn-inverse pull-right">
      {% trans 'Delete' %}
    </a>


    <h3>{% trans 'updates' %}</h3>
    <table class="table table-striped table-linearize">
      {% for created_at, type, data in changes %}
        {% if type == 'change' %}
          <tr>
            <td>
              <i class="glyphicon glyphicon-time" title="{% trans 'change' %}"></i>
            </td>
            <td colspan="2">
              <strong>
                {{ data.version.pretty_user_name }}
                <small>{{ data.version.created_at|date:'SHORT_DATETIME_FORMAT' }}</small>
              </strong>
              <ul>
                {% for pretty in data.changes %}
                  <li>{{ pretty }}</li>
                {% endfor %}
              </ul>
            </td>
          </tr>
        {% elif type == 'comment' %}
          <tr>
            <td>
              <i class="glyphicon glyphicon-comment" title="{% trans 'comment' %}"></i>
            </td>
            <td>
              <strong>
                {{ data.created_by }}
                <small>{{ data.created_at|date:'SHORT_DATETIME_FORMAT' }}</small>
              </strong><br>
              {{ data.notes_html }}
            </td>
            <td class="text-right">
              {% if data.created_by == request.user %}
                <a href="{{ data.urls.update }}" data-toggle="ajaxmodal">
                  <i class="glyphicon glyphicon-pencil"></i>
                </a><br>
                <a href="{{ data.urls.delete }}" data-toggle="ajaxmodal">
                  <i class="glyphicon glyphicon-trash"></i>
                </a>
              {% endif %}
            </td>
          </tr>
        {% elif type == 'hours' %}
          <tr>
            <td>
              <i class="glyphicon glyphicon-hourglass" title="{% trans 'hours' %}"></i>
            </td>
            <td>
              <strong>
                {{ data.rendered_by }}
                <small>{{ data.created_at|date:'SHORT_DATETIME_FORMAT' }}</small>
              </strong><br>
              {{ data.hours }}h, {{ data.description|linebreaksbr }}
            </td>
          </tr>
        {% else %}
          <tr>
            <td><h4>{% trans 'Unknown update' %}: {{ data }}</h4></td>
          </tr>
        {% endif %}
      {% endfor %}
      <tr>
        <td><i class="glyphicon glyphicon-comment"></i></td>
        <td>
          <a name="comments"></a>
          <form method="post" action="{{ request.path }}" class="form">
            <input type="hidden" name="form" value="comment_form"/>
            {% csrf_token %}
            {% bootstrap_form comment_form layout='inline' %}
            <button type="submit" class="btn btn-primary">
              {% trans 'add comment' %}
            </button>
          </form>
        </td>
        <td></td>
      </tr>
    </table>

  </div>
</div>

{% endblock %}
